{% extends "wiki/base.html" %}
{% load wiki_tags i18n humanize %}

{% block wiki_pagetitle %}{% trans "Global history" %}{% endblock %}

{% block wiki_contents %}

<h1 class="page-header">{% trans "Global history" %}</h1>

{% spaceless %}
<div class="row">
  <div class="lead col-xs-12">
    <div class="pull-right">
      <a class="btn btn-default"
         {% if only_last == "1" %}
           href="{% url 'wiki:globalhistory' only_last=0 %}">
           {% trans "Show all revisions of all articles" %}
         {% else %}
           href="{% url 'wiki:globalhistory' only_last=1 %}">
           {% trans "Show last revision of every article" %}
         {% endif %}
      </a>
    </div>
    {% with paginator.object_list.count as cnt %}
      {% blocktrans count cnt=cnt trimmed %}
        List of <strong>{{ cnt }} change</strong> in the wiki.
        {% plural %}
        List of <strong>{{ cnt }} changes</strong> in the wiki.
      {% endblocktrans %}
    {% endwith %}
  </div>
</div>

<div class="row">
  <div class="col-sm-12">
  {% if revisions %}
    {% for revision in revisions %}

      {% with revision.article as article %}

      <div class="panel-group" id="accordion{{ revision.revision_number }}">
        <div class="panel panel-default">
          <div class="panel-heading">
            <a class="panel-toggle" style="float: left;" href="#collapse{{ revision.revision_number }}" onclick="get_diff_json('{% url 'wiki:diff' revision.id %}', $('#collapse{{ revision.revision_number }}'))">
              {% if revision == article.current_revision %}
                <i class="fa fa-flag"></i>
              {% else %}
                <i class="fa fa-plus"></i>
              {% endif %}
              {% include "wiki/includes/revision_info.html" with current_revision=article.current_revision %}
              <div class="text-muted">
                <small>
                {% if revision.user_message %}
                  {{ revision.user_message }}
                {% elif revision.automatic_log %}
                  {{ revision.automatic_log }}
                {% else %}
                  ({% trans "no log message" %})
                {% endif %}
                </small>
              </div>
            </a>
            <div class="progress progress-striped active" style="display: none; width: 40px; float: left; margin-top: 7px; margin-bottom: -7px;">
              <div class="bar" style="width: 100%;"></div>
            </div>
            <div class="pull-right" style="vertical-align: middle; margin: 8px 8px;">
              <button type="submit" class="btn btn-default" onclick="$('#previewModal').modal('show'); this.form.target='previewWindow'; this.form.r.value='{{ revision.id }}'; this.form.action='{% url 'wiki:preview_revision' article.id %}'; $('#previewModal .switch-to-revision').attr('href', '{% url 'wiki:change_revision' path=urlpath.path article_id=article.id revision_id=revision.id %}')">
                <span class="fa fa-eye fa-fw"></span>
                {% trans "Preview this revision" %}
              </button>

            </div>
            <div style="clear: both"></div>
          </div>
          <div id="collapse{{ revision.revision_number }}" class="panel-collapse collapse">
            <div class="panel-body diff-container" style="padding: 0;">
              <dl class="dl-horizontal">
                <dt>{% trans "Auto log:" %}</dt>
                <dd>{{ revision.automatic_log|default:"-"|linebreaksbr }}</dd>
              </dl>
              <table class="table table-condensed" style="margin: 0; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th class="linenumber">{% if revision.previous_revision %}#{{revision.previous_revision.revision_number}}{% endif %}</th>
                    <th class="linenumber">#{{revision.revision_number}}</th>
                    <th>{% trans "Change" %}</th>
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>

{% comment %}
          <tr>
            <td>
              {{ article_revision.revision_number }}
            </td>
            <td>
              <a href="{% url 'wiki:get' article_revision.article.pk %}">
                {{ article_revision.article }}
              </a>
            </td>
            <td>
              {% if article_revision.user_message %}
                {{ article_revision.user_message }}
              {% elif article_revision.automatic_log %}
                {{ article_revision.automatic_log }}
              {% else %}
                ({% trans "no log message" %})
              {% endif %}
              {% if article_revision.deleted %}
                <span class="badge badge-important">{% trans "deleted" %}</span>
              {% endif %}
              {% if article_revision.previous_revision.deleted and not article_revision.deleted %}
                <span class="badge badge-success">{% trans "restored" %}</span>
              {% endif %}
              {% if article_revision.locked %}
                <span class="badge">{% trans "locked" %}</span>
              {% endif %}
              {% if article_revision.previous_revision.locked and not revision.locked %}
                <span class="badge">{% trans "unlocked" %}</span>
              {% endif %}
            </td>
            <td>
              {% if article_revision.user %}
                {{ article_revision.user }}
              {% else %}
                {% if article_revision.article|can_moderate:user %}
                  {{ article_revision.ip_address|default:"anonymous (IP not logged)" }}
                {% else %}
                  {% trans "anonymous (IP logged)" %}i
                {% endif %}
              {% endif %}
            </td>
            <td>
              {{article_revision.modified}}
            </td>
            <td class="text-right">
              <a href="{% url 'wiki:history' article_revision.article.pk %}" class="btn btn-info btn-xs">{% trans "Go to article history" %}</a>
              <a href="{% url 'wiki:get' article_revision.article.pk %}" class="btn btn-primary btn-xs">{% trans "Go to article" %}</a>
            </td>
          </tr>
{% endcomment %}


    {% endwith %}
    {% endfor %}

  {% else %}
    <div class="alert alert-info">
      {% if page %}
        {% trans "No more changes to display!" %}
        <a href="?page={{page|add:"-1"}}">{% trans "Go back to previous page" %}</a>
      {% else %}
        {% trans "No changes to display!" %}
      {% endif %}
    </div>
  {% endif %}

  {% include "wiki/includes/pagination.html" %}
</div>
</div>
{% endspaceless %}
{% endblock %}
